<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Valentine's Treasure Hunt üíù</title>
  <style>
    /* =========================
       GLOBAL STYLES
       ========================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #87CEEB;
      font-family: 'Courier New', Courier, monospace;
    }
    
    /* =========================
       GAME CONTAINER
       ========================= */
    #gameContainer {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    /* =========================
       CANVAS
       ========================= */
    #gameCanvas {
      display: block;
      border: 3px solid #8B4513;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      max-width: 95%;
      height: auto;
    }
    
    /* =========================
       UI ELEMENTS
       ========================= */
    #instructions {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: #fff;
      font-size: 14px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      padding: 5px 15px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      z-index: 10;
      max-width: 90%;
    }
    
    #healthBar {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 15px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .health {
      display: inline-block;
      width: 150px;
      height: 15px;
      background: #333;
      border: 2px solid #fff;
      position: relative;
      overflow: hidden;
    }
    
    .health-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #ff1493, #ff69b4);
      transition: width 0.3s ease;
    }
    
    /* =========================
       MOBILE CONTROLS
       ========================= */
    #mobileControls {
      position: fixed;
      bottom: 10px;
      width: 100%;
      display: none;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 15px;
      z-index: 100;
    }
    
    #mobileControls.active {
      display: flex;
    }
    
    #dpad {
      position: relative;
      width: 140px;
      height: 140px;
    }
    
    .dpad-btn {
      position: absolute;
      width: 45px;
      height: 45px;
      background: rgba(255, 255, 255, 0.4);
      border: 3px solid rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      font-weight: bold;
      transition: all 0.1s ease;
    }
    
    .dpad-btn:active {
      background: rgba(255, 255, 255, 0.7);
      transform: scale(0.9);
    }
    
    #btnUp { top: 0; left: 47px; }
    #btnDown { bottom: 0; left: 47px; }
    #btnLeft { top: 47px; left: 0; }
    #btnRight { top: 47px; right: 0; }
    
    #attackBtn {
      width: 70px;
      height: 70px;
      background: rgba(220, 20, 60, 0.5);
      border: 4px solid rgba(220, 20, 60, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      transition: all 0.1s ease;
    }
    
    #attackBtn:active {
      background: rgba(220, 20, 60, 0.8);
      transform: scale(0.9);
    }
    
    /* =========================
       VALENTINE'S CARD
       ========================= */
    #card {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #ff6b9d 0%, #ffc3dc 100%);
      padding: 20px;
      border-radius: 15px;
      border: 5px solid #fff;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
      text-align: center;
      max-width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 1000;
      -webkit-overflow-scrolling: touch;
    }
    
    #card.show {
      display: block;
      animation: cardAppear 0.8s ease-out forwards;
    }
    
    @keyframes cardAppear {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
        opacity: 0;
      }
      60% {
        transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }
    
    #card h1 {
      font-size: 28px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 15px;
      line-height: 1.2;
    }
    
    #card p {
      font-size: 16px;
      color: #fff;
      line-height: 1.5;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      margin: 8px 0;
    }
    
    #pixelCouple {
      margin: 15px auto;
      display: block;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      max-width: 100%;
      height: auto;
    }
    
    /* =========================
       FLOATING HEARTS
       ========================= */
    .hearts {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }
    
    .heart {
      position: absolute;
      font-size: 25px;
      animation: float 4s ease-in infinite;
      opacity: 0;
    }
    
    @keyframes float {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* =========================
       MOBILE RESPONSIVE
       ========================= */
    @media (max-width: 600px) {
      #instructions {
        font-size: 12px;
        padding: 4px 10px;
      }
      
      #healthBar {
        font-size: 12px;
        padding: 6px 12px;
      }
      
      .health {
        width: 120px;
        height: 12px;
      }
      
      #card {
        padding: 15px;
        max-height: 80vh;
      }
      
      #card h1 {
        font-size: 22px;
        margin-bottom: 10px;
      }
      
      #card p {
        font-size: 14px;
        line-height: 1.4;
      }
    }
  </style>
</head>
<body>

<!-- Game Container -->
<div id="gameContainer">
  <div id="instructions">ARROW KEYS/WASD to move ‚Ä¢ SPACE to attack ‚Ä¢ Defeat the slime! üíù</div>
  <div id="healthBar">
    HP: 
    <span class="health">
      <span class="health-fill" id="healthFill"></span>
    </span>
  </div>
  <canvas id="gameCanvas" width="800" height="600"></canvas>
</div>

<!-- Mobile Touch Controls -->
<div id="mobileControls">
  <div id="dpad">
    <div class="dpad-btn" id="btnUp">‚ñ≤</div>
    <div class="dpad-btn" id="btnDown">‚ñº</div>
    <div class="dpad-btn" id="btnLeft">‚óÄ</div>
    <div class="dpad-btn" id="btnRight">‚ñ∂</div>
  </div>
  <div id="attackBtn">‚öîÔ∏è</div>
</div>

<!-- Valentine's Card -->
<div id="card">
  <h1>üíù Happy Valentine's Day! üíù</h1>
  <canvas id="pixelCouple" width="200" height="120"></canvas>
  <p style="margin-top: 15px;"><strong>For my Love, Justin,</strong></p>
  <p style="margin-top: 10px;">You make every day feel like an adventure worth taking. Thank you for being my player 2 in this game called life. I love you more than all the pixels in the world! üíñ</p>
  <p style="margin-top: 15px;"><strong>Love always,<br>Mikayla üíï</strong></p>
</div>

<!-- Floating Hearts Container -->
<div class="hearts" id="heartsContainer"></div>

<script>
'use strict';

// ========================================
// INITIALIZATION & SETUP
// ========================================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
ctx.imageSmoothingEnabled = false;

// Detect platform
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                 (navigator.maxTouchPoints > 0 && navigator.maxTouchPoints > 2);

// Configure UI for platform
if (isMobile) {
  document.getElementById('mobileControls').classList.add('active');
  document.getElementById('instructions').textContent = 'Tap controls to move and attack! Defeat the slime! üíù';
  
  // Prevent scrolling on mobile
  document.addEventListener('touchmove', (e) => {
    e.preventDefault();
  }, { passive: false });
}

// ========================================
// GAME STATE
// ========================================

const gameState = {
  player: {
    x: 100,
    y: 350,
    width: 32,
    height: 52,
    speed: 4,
    health: 100,
    maxHealth: 100,
    facingRight: true,
    isAttacking: false,
    attackCooldown: 0
  },
  enemy: {
    x: 400,
    y: 330,
    width: 48,
    height: 48,
    health: 30,
    maxHealth: 30,
    speed: 1.5,
    isAlive: true,
    knockbackX: 0,
    knockbackY: 0
  },
  obstacle: {
    x: 300,
    y: 300,
    width: 64,
    height: 80
  },
  chest: {
    x: 650,
    y: 350,
    width: 48,
    height: 40,
    isOpen: false,
    canOpen: false
  },
  key: {
    x: 0,
    y: 0,
    width: 24,
    height: 24,
    isDropped: false,
    isCollected: false
  }
};

// Control state
const controls = {
  up: false,
  down: false,
  left: false,
  right: false
};

const keys = {};
let particles = [];

// ========================================
// INPUT HANDLING
// ========================================

// Keyboard controls (desktop)
document.addEventListener('keydown', (e) => {
  keys[e.key.toLowerCase()] = true;
  
  if (e.key === ' ' || e.key === 'Spacebar') {
    e.preventDefault();
    if (!gameState.player.isAttacking && gameState.player.attackCooldown <= 0) {
      gameState.player.isAttacking = true;
      gameState.player.attackCooldown = 30;
    }
  }
});

document.addEventListener('keyup', (e) => {
  keys[e.key.toLowerCase()] = false;
});

// Touch controls (mobile)
function setupTouchControl(elementId, direction) {
  const btn = document.getElementById(elementId);
  
  const startHandler = (e) => {
    e.preventDefault();
    if (direction === 'attack') {
      if (!gameState.player.isAttacking && gameState.player.attackCooldown <= 0) {
        gameState.player.isAttacking = true;
        gameState.player.attackCooldown = 30;
      }
    } else {
      controls[direction] = true;
    }
  };
  
  const endHandler = (e) => {
    e.preventDefault();
    if (direction !== 'attack') {
      controls[direction] = false;
    }
  };
  
  btn.addEventListener('touchstart', startHandler);
  btn.addEventListener('touchend', endHandler);
  btn.addEventListener('touchcancel', endHandler);
}

if (isMobile) {
  setupTouchControl('btnUp', 'up');
  setupTouchControl('btnDown', 'down');
  setupTouchControl('btnLeft', 'left');
  setupTouchControl('btnRight', 'right');
  setupTouchControl('attackBtn', 'attack');
}

// ========================================
// DRAWING FUNCTIONS
// ========================================

function drawGround() {
  // Sky
  ctx.fillStyle = '#87CEEB';
  ctx.fillRect(0, 0, 800, 450);
  
  // Grass surface
  ctx.fillStyle = '#7EC850';
  ctx.fillRect(0, 450, 800, 150);
  
  // Grass details
  ctx.fillStyle = '#6AB83C';
  for (let i = 0; i < 800; i += 32) {
    ctx.fillRect(i, 450, 16, 4);
    ctx.fillRect(i + 8, 456, 16, 4);
  }
  
  // Dirt layer
  ctx.fillStyle = '#8B6F47';
  ctx.fillRect(0, 460, 800, 140);
  
  // Dirt texture
  ctx.fillStyle = '#6B5535';
  for (let y = 470; y < 600; y += 20) {
    for (let x = 0; x < 800; x += 30) {
      ctx.fillRect(x + (y % 40), y, 8, 8);
    }
  }
}

function drawCloud(x, y) {
  ctx.fillStyle = '#fff';
  ctx.fillRect(x, y, 16, 16);
  ctx.fillRect(x + 16, y - 8, 16, 16);
  ctx.fillRect(x + 32, y, 16, 16);
  ctx.fillRect(x + 16, y + 8, 16, 16);
}

function drawObstacle() {
  const o = gameState.obstacle;
  
  // Main rock body
  ctx.fillStyle = '#696969';
  ctx.fillRect(o.x + 8, o.y + 20, 48, 60);
  ctx.fillRect(o.x + 16, o.y + 10, 32, 20);
  ctx.fillRect(o.x, o.y + 40, 64, 40);
  
  // Highlights
  ctx.fillStyle = '#A9A9A9';
  ctx.fillRect(o.x + 12, o.y + 24, 12, 12);
  ctx.fillRect(o.x + 32, o.y + 14, 8, 8);
  
  // Shadows
  ctx.fillStyle = '#404040';
  ctx.fillRect(o.x + 40, o.y + 50, 20, 30);
}

function drawPlayer() {
  const p = gameState.player;
  const px = p.x;
  const py = p.y;
  
  // Head
  ctx.fillStyle = '#FFD1A1';
  ctx.fillRect(px + 8, py, 16, 16);
  
  // Hair (short brown)
  ctx.fillStyle = '#654321';
  ctx.fillRect(px + 8, py - 4, 16, 6);
  ctx.fillRect(px + 6, py, 20, 3);
  
  // Body (red shirt)
  ctx.fillStyle = '#DC143C';
  ctx.fillRect(px + 4, py + 16, 24, 20);
  
  // Arms
  ctx.fillStyle = '#FFD1A1';
  ctx.fillRect(px, py + 16, 4, 16);
  ctx.fillRect(px + 28, py + 16, 4, 16);
  
  // Legs (khaki pants)
  ctx.fillStyle = '#C3B091';
  ctx.fillRect(px + 8, py + 36, 8, 16);
  ctx.fillRect(px + 16, py + 36, 8, 16);
  
  // Eyes
  ctx.fillStyle = '#000';
  if (p.facingRight) {
    ctx.fillRect(px + 16, py + 6, 3, 3);
    ctx.fillRect(px + 22, py + 6, 3, 3);
  } else {
    ctx.fillRect(px + 10, py + 6, 3, 3);
    ctx.fillRect(px + 16, py + 6, 3, 3);
  }
  
  // Sword
  ctx.fillStyle = '#C0C0C0';
  if (p.facingRight) {
    if (p.isAttacking) {
      // Horizontal slash
      ctx.fillRect(px + 32, py + 12, 20, 4);
      ctx.fillStyle = '#FFD700';
      ctx.fillRect(px + 48, py + 8, 4, 12);
    } else {
      // Sword at side
      ctx.fillRect(px + 28, py + 20, 4, 16);
      ctx.fillStyle = '#FFD700';
      ctx.fillRect(px + 26, py + 16, 8, 4);
    }
  } else {
    if (p.isAttacking) {
      // Horizontal slash
      ctx.fillRect(px - 20, py + 12, 20, 4);
      ctx.fillStyle = '#FFD700';
      ctx.fillRect(px - 20, py + 8, 4, 12);
    } else {
      // Sword at side
      ctx.fillRect(px, py + 20, 4, 16);
      ctx.fillStyle = '#FFD700';
      ctx.fillRect(px - 2, py + 16, 8, 4);
    }
  }
}

function drawEnemy() {
  const e = gameState.enemy;
  if (!e.isAlive) return;
  
  const ex = e.x;
  const ey = e.y;
  
  // Slime body (green)
  ctx.fillStyle = '#32CD32';
  ctx.fillRect(ex + 8, ey + 16, 32, 32);
  ctx.fillRect(ex + 4, ey + 24, 40, 16);
  ctx.fillRect(ex, ey + 32, 48, 8);
  
  // Slime highlights
  ctx.fillStyle = '#90EE90';
  ctx.fillRect(ex + 12, ey + 20, 12, 8);
  ctx.fillRect(ex + 28, ey + 28, 8, 8);
  
  // Eyes
  ctx.fillStyle = '#000';
  ctx.fillRect(ex + 14, ey + 28, 6, 6);
  ctx.fillRect(ex + 28, ey + 28, 6, 6);
  
  // Eye shine
  ctx.fillStyle = '#fff';
  ctx.fillRect(ex + 16, ey + 30, 2, 2);
  ctx.fillRect(ex + 30, ey + 30, 2, 2);
  
  // Health bar
  if (e.health < e.maxHealth) {
    ctx.fillStyle = '#000';
    ctx.fillRect(ex, ey - 8, 48, 6);
    ctx.fillStyle = '#ff1493';
    ctx.fillRect(ex + 1, ey - 7, (46 * e.health / e.maxHealth), 4);
  }
}

function drawKey() {
  const k = gameState.key;
  if (!k.isDropped || k.isCollected) return;
  
  const kx = k.x;
  const ky = k.y;
  
  // Key body (golden)
  ctx.fillStyle = '#FFD700';
  ctx.fillRect(kx + 4, ky, 8, 16);
  
  // Key head (circle)
  ctx.fillRect(kx + 2, ky, 12, 8);
  ctx.fillRect(kx, ky + 2, 16, 4);
  
  // Key hole in head
  ctx.fillStyle = '#000';
  ctx.fillRect(kx + 6, ky + 2, 4, 4);
  
  // Key teeth
  ctx.fillStyle = '#FFD700';
  ctx.fillRect(kx + 8, ky + 12, 4, 4);
  ctx.fillRect(kx + 8, ky + 18, 4, 4);
  ctx.fillRect(kx + 12, ky + 18, 4, 4);
  
  // Sparkle
  ctx.fillStyle = '#FFF';
  ctx.fillRect(kx + 10, ky + 4, 2, 2);
  
  // Label
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 12px Courier New';
  ctx.textAlign = 'center';
  ctx.fillText('Key!', kx + 12, ky - 4);
  ctx.textAlign = 'left';
}

function drawChest() {
  const c = gameState.chest;
  
  if (!c.isOpen) {
    // Closed chest
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(c.x, c.y + 16, 48, 24);
    
    ctx.fillStyle = '#A0522D';
    ctx.fillRect(c.x, c.y, 48, 20);
    
    // Lock
    ctx.fillStyle = '#FFD700';
    ctx.fillRect(c.x + 20, c.y + 16, 8, 12);
    ctx.fillRect(c.x + 18, c.y + 20, 12, 4);
    
    // Highlight
    ctx.fillStyle = '#CD853F';
    ctx.fillRect(c.x + 4, c.y + 4, 8, 4);
  } else {
    // Open chest
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(c.x, c.y + 20, 48, 20);
    
    ctx.fillStyle = '#A0522D';
    ctx.fillRect(c.x - 4, c.y - 8, 48, 20);
    
    // Glowing heart inside
    ctx.fillStyle = '#FF1493';
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#FF1493';
    ctx.fillRect(c.x + 16, c.y + 24, 16, 16);
    ctx.shadowBlur = 0;
  }
  
  // Interaction hint
  if (c.canOpen && !c.isOpen) {
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 16px Courier New';
    ctx.textAlign = 'center';
    ctx.fillText(isMobile ? 'TAP HERE!' : 'Press E', c.x + 24, c.y - 10);
    ctx.textAlign = 'left';
  }
}

function drawPixelCouple() {
  const coupleCanvas = document.getElementById('pixelCouple');
  const cctx = coupleCanvas.getContext('2d');
  cctx.imageSmoothingEnabled = false;
  cctx.clearRect(0, 0, 200, 120);
  
  // Mikayla (left)
  const mx = 40;
  const my = 30;
  
  // Head
  cctx.fillStyle = '#FFD1A1';
  cctx.fillRect(mx, my, 24, 24);
  
  // Hair (long ashy beige blonde)
  cctx.fillStyle = '#E8DCC8';
  cctx.fillRect(mx, my - 8, 24, 12);
  cctx.fillRect(mx - 4, my, 32, 8);
  cctx.fillRect(mx - 6, my + 8, 8, 32);
  cctx.fillRect(mx + 22, my + 8, 8, 32);
  
  // Eyes
  cctx.fillStyle = '#000';
  cctx.fillRect(mx + 6, my + 10, 3, 3);
  cctx.fillRect(mx + 15, my + 10, 3, 3);
  
  // Smile
  cctx.fillRect(mx + 8, my + 16, 8, 2);
  
  // Dress (baby pink)
  cctx.fillStyle = '#FFB6C1';
  cctx.fillRect(mx - 4, my + 24, 32, 32);
  cctx.fillRect(mx - 8, my + 30, 40, 6);
  
  // Arms
  cctx.fillStyle = '#FFD1A1';
  cctx.fillRect(mx - 8, my + 24, 6, 20);
  cctx.fillRect(mx + 26, my + 24, 6, 20);
  
  // Legs
  cctx.fillRect(mx + 4, my + 56, 6, 16);
  cctx.fillRect(mx + 14, my + 56, 6, 16);
  
  // Shoes (white)
  cctx.fillStyle = '#FFFFFF';
  cctx.fillRect(mx + 2, my + 68, 8, 4);
  cctx.fillRect(mx + 14, my + 68, 8, 4);
  
  // Justin (right)
  const bx = 120;
  const by = 30;
  
  // Head
  cctx.fillStyle = '#FFD1A1';
  cctx.fillRect(bx, by, 24, 24);
  
  // Hair (short brown)
  cctx.fillStyle = '#654321';
  cctx.fillRect(bx, by - 6, 24, 10);
  cctx.fillRect(bx - 2, by, 28, 4);
  
  // Eyes
  cctx.fillStyle = '#000';
  cctx.fillRect(bx + 6, by + 10, 3, 3);
  cctx.fillRect(bx + 15, by + 10, 3, 3);
  
  // Smile
  cctx.fillRect(bx + 8, by + 16, 8, 2);
  
  // Shirt (red)
  cctx.fillStyle = '#DC143C';
  cctx.fillRect(bx - 4, by + 24, 32, 24);
  
  // Arms
  cctx.fillStyle = '#FFD1A1';
  cctx.fillRect(bx - 8, by + 24, 6, 20);
  cctx.fillRect(bx + 26, by + 24, 6, 20);
  
  // Pants (khaki)
  cctx.fillStyle = '#C3B091';
  cctx.fillRect(bx, by + 48, 24, 24);
  
  // Legs
  cctx.fillRect(bx + 4, by + 56, 6, 16);
  cctx.fillRect(bx + 14, by + 56, 6, 16);
  
  // Shoes (brown)
  cctx.fillStyle = '#8B4513';
  cctx.fillRect(bx + 2, by + 68, 8, 4);
  cctx.fillRect(bx + 14, by + 68, 8, 4);
  
  // Holding hands
  cctx.fillStyle = '#FFD1A1';
  cctx.fillRect(mx + 32, my + 40, 56, 6);
  
  // Heart between them
  cctx.fillStyle = '#FF1493';
  cctx.fillRect(mx + 52, my + 36, 8, 8);
  cctx.fillRect(mx + 48, my + 40, 16, 8);
  cctx.fillRect(mx + 52, my + 48, 8, 8);
}

// ========================================
// PARTICLE SYSTEM
// ========================================

function createParticles(x, y, color = '#FF1493') {
  for (let i = 0; i < 15; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6 - 2,
      life: 30,
      size: Math.random() * 5 + 3,
      color: color
    });
  }
}

function updateParticles() {
  particles = particles.filter(p => p.life > 0);
  
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.3; // Gravity
    p.life--;
    
    ctx.fillStyle = p.color;
    ctx.globalAlpha = p.life / 30;
    ctx.fillRect(p.x, p.y, p.size, p.size);
  });
  
  ctx.globalAlpha = 1;
}

// ========================================
// COLLISION DETECTION
// ========================================

function checkCollision(rect1, rect2) {
  return rect1.x < rect2.x + rect2.width &&
         rect1.x + rect1.width > rect2.x &&
         rect1.y < rect2.y + rect2.height &&
         rect1.y + rect1.height > rect2.y;
}

// ========================================
// GAME LOGIC
// ========================================

function update() {
  const p = gameState.player;
  const e = gameState.enemy;
  const c = gameState.chest;
  const o = gameState.obstacle;
  const k = gameState.key;
  
  // Attack cooldown
  if (p.attackCooldown > 0) {
    p.attackCooldown--;
  }
  
  // Handle attack
  if (p.isAttacking) {
    setTimeout(() => { p.isAttacking = false; }, 200);
    
    if (e.isAlive) {
      const attackRange = {
        x: p.facingRight ? p.x + 20 : p.x - 30,
        y: p.y,
        width: 40,
        height: 50
      };
      
      if (checkCollision(attackRange, e)) {
        e.health -= 10;
        createParticles(e.x + 24, e.y + 24, '#32CD32');
        
        // Knockback
        e.knockbackX = p.facingRight ? 30 : -30;
        e.knockbackY = -20;
        
        if (e.health <= 0) {
          e.isAlive = false;
          createParticles(e.x + 24, e.y + 24, '#32CD32');
          
          // Drop key
          k.x = e.x + 12;
          k.y = e.y + 12;
          k.isDropped = true;
        }
      }
    }
  }
  
  // Player movement
  let newX = p.x;
  let newY = p.y;
  
  if (controls.left || keys['arrowleft'] || keys['a']) {
    newX -= p.speed;
    p.facingRight = false;
  }
  if (controls.right || keys['arrowright'] || keys['d']) {
    newX += p.speed;
    p.facingRight = true;
  }
  if (controls.up || keys['arrowup'] || keys['w']) {
    newY -= p.speed;
  }
  if (controls.down || keys['arrowdown'] || keys['s']) {
    newY += p.speed;
  }
  
  // Check collision with obstacle
  const futurePlayer = { x: newX, y: newY, width: p.width, height: p.height };
  if (!checkCollision(futurePlayer, o)) {
    p.x = newX;
    p.y = newY;
  }
  
  // Keep player in bounds
  p.x = Math.max(0, Math.min(800 - p.width, p.x));
  p.y = Math.max(0, Math.min(450 - p.height, p.y));
  
  // Enemy AI
  if (e.isAlive) {
    // Apply knockback
    if (Math.abs(e.knockbackX) > 0.5 || Math.abs(e.knockbackY) > 0.5) {
      e.x += e.knockbackX;
      e.y += e.knockbackY;
      e.knockbackX *= 0.8;
      e.knockbackY *= 0.8;
    } else {
      // Chase player
      const dx = p.x - e.x;
      const dy = p.y - e.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist > 60) {
        e.x += (dx / dist) * e.speed;
        e.y += (dy / dist) * e.speed;
      }
    }
    
    // Damage player on contact
    if (checkCollision(p, e)) {
      p.health = Math.max(0, p.health - 0.5);
      document.getElementById('healthFill').style.width = (p.health / p.maxHealth * 100) + '%';
    }
  }
  
  // Key collection
  if (k.isDropped && !k.isCollected) {
    if (checkCollision(p, k)) {
      k.isCollected = true;
      createParticles(k.x + 12, k.y + 12, '#FFD700');
    }
  }
  
  // Chest interaction
  if (!e.isAlive && k.isCollected) {
    const distance = Math.sqrt(
      Math.pow(p.x - c.x, 2) + 
      Math.pow(p.y - c.y, 2)
    );
    
    c.canOpen = distance < 80 && !c.isOpen;
    
    // Open with E key (desktop)
    if (c.canOpen && (keys['e'] || keys['E'])) {
      openChest();
    }
  }
}

function openChest(e) {
  const c = gameState.chest;
  if (!c.canOpen || c.isOpen) return;
  
  // For tap events, check if tap is on chest
  if (e && e.type === 'touchend') {
    e.preventDefault();
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    const touch = e.changedTouches[0];
    const x = (touch.clientX - rect.left) * scaleX;
    const y = (touch.clientY - rect.top) * scaleY;
    
    // Only open if tapped on chest
    if (x < c.x || x > c.x + c.width || y < c.y || y > c.y + c.height) {
      return;
    }
  }
  
  // Open chest
  c.isOpen = true;
  createParticles(c.x + 24, c.y + 20);
  
  setTimeout(() => {
    drawPixelCouple();
    document.getElementById('card').classList.add('show');
    createFloatingHearts();
  }, 500);
}

// Chest tap handler for mobile
canvas.addEventListener('touchend', openChest);

function createFloatingHearts() {
  const heartsContainer = document.getElementById('heartsContainer');
  
  const heartInterval = setInterval(() => {
    const heart = document.createElement('div');
    heart.className = 'heart';
    heart.innerHTML = 'üíñ';
    heart.style.left = Math.random() * 100 + '%';
    heart.style.animationDelay = Math.random() * 2 + 's';
    heart.style.animationDuration = (Math.random() * 2 + 3) + 's';
    heartsContainer.appendChild(heart);
    
    setTimeout(() => heart.remove(), 5000);
  }, 300);
}

// ========================================
// RENDER LOOP
// ========================================

function draw() {
  ctx.clearRect(0, 0, 800, 600);
  
  drawGround();
  drawCloud(150, 100);
  drawCloud(500, 150);
  drawCloud(650, 80);
  drawObstacle();
  drawEnemy();
  drawKey();
  drawChest();
  drawPlayer();
  updateParticles();
}

// ========================================
// GAME LOOP
// ========================================

let lastTime = 0;

function gameLoop(currentTime) {
  const deltaTime = currentTime - lastTime;
  
  // Target 60 FPS
  if (deltaTime >= 16) {
    update();
    draw();
    lastTime = currentTime;
  }
  
  requestAnimationFrame(gameLoop);
}

// Start the game
requestAnimationFrame(gameLoop);
</script>

</body>
</html>
